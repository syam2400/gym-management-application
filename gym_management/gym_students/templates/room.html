{% extends 'base.html' %}
{% load static %}
{% block content %} 

<style>
  body {
    background-color: #f7f7f7;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh; /* Full viewport height */
    margin: 0; /* Remove default margin */
    padding: 20px;
  }
  
  .chat-container {
    width: 100%;
    max-width: 600px; /* Adjust the maximum width as needed */
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    height: 500px; /* Fixed height for the chat container */
    margin: auto; /* Center the chat container on the page */
  }
  
  .messages-box {
    overflow-y: auto; /* Enable scrolling for the messages box */
    padding: 15px;
    flex-grow: 1;
  }
  
  /* Scrollbar styling */
  .messages-box::-webkit-scrollbar {
    width: 5px;
  }
  .messages-box::-webkit-scrollbar-track {
    background: #f1f1f1;
  }
  .messages-box::-webkit-scrollbar-thumb {
    background: #ddd;
  }
  .messages-box::-webkit-scrollbar-thumb:hover {
    background: #ccc;
  }
  
  .message {
    margin-bottom: 15px;
    line-height: 1.4;
  }
  
  .sender, .receiver {
    display: flex;
    align-items: flex-end;
  }
  
  .message-text {
    padding: 10px;
    border-radius: 20px;
    display: inline-block;
    max-width: 70%;
  }
  
  .sender .message-text {
    background-color: #007bff;
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 0;
  }
  
  .receiver .message-text {
    background-color: #e9ecef;
    border-bottom-left-radius: 0;
  }
  
  .form-area {
    border-top: 1px solid #eee;
    padding: 10px;
    display: flex;
    width: 100%; /* Ensure the form area spans the entire width */
  }
  
  input[type="text"] {
    flex: 1; /* Allow the input to fill the available space */
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 20px;
    margin-right: 10px; /* Space between input and submit button */
  }
  
  input[type="submit"] {
    padding: 10px 20px;
    border-radius: 20px;
    border: none;
    background-color: #007bff;
    color: white;
    cursor: pointer;
  }
  
  @media (max-width: 768px) {
    .chat-container {
      width: 95%; /* Make the chat container wider on smaller screens */
    }
  }
  </style>
    <!-- Chat Box-->
    {% if user.is_authenticated %}
    <div class="container py-5 px-4" style="margin-top: 100px;">
      <div class="row rounded-lg overflow-hidden shadow">
          <div class="col-6 px-0">
              {% if messages %}
                  <div class="px-4 py-5 chat-box bg-white fixed-height-chat" id="chatbox">
                      {% for message in messages %}
                          {% if message.user.username == request.user.username %}
                              <div class="media w-50 ml-auto mb-3">
                                  <div class="media-body">
                                      <div class="bg-primary rounded py-2 px-3 mb-2">
                                          <p class="text-small mb-0 text-white">{{ message.content }}</p>
                                      </div>
                                      <p class="small text-muted text-right">12:00 PM | Aug 13</p>
                                  </div>
                              </div>
                          {% else %}
                              <div class="media w-50 mb-3">
                                  <img src="https://bootstrapious.com/i/snippets/sn-chat/avatar.svg" alt="user" width="50" class="rounded-circle">
                                  <div class="media-body ml-3">
                                      <div class="bg-light rounded py-2 px-3 mb-2">
                                          <p class="text-small mb-0 text-muted">{{ message.content }}</p>
                                      </div>
                                      <p class="small text-muted">12:00 PM | Aug 13</p>
                                  </div>
                              </div>
                          {% endif %}
                      {% endfor %}
                  </div>
              {% else %}
                  <div class="jumbotron" id="chatbox" style="padding: 4px 2px;">
                      <b style="color: white;">No Messages in this Room.</b>
                  </div>
              {% endif %}
  
              <form action="#" class="bg-dark" style="color: white;" onsubmit="sendMessage(event)">
  
                  <div class="input-group">
                      <input type="text" placeholder="Type a message" id="my_input"
                             class="form-control rounded-0 border-0 py-4 bg-light">
  
                      <div class="input-group-append">
                          <button id="submit_button" type="submit" value="send" class="btn btn-link">
                              <i class="fa fa-paper-plane"></i>
                          </button>
                      </div>
                  </div>
              </form>
  
          </div>
      </div>
  </div>


{{slug|json_script:"room_slug"}}

<script>
  function sendMessage(event) {
    console.log("sendMessage function called");
    event.preventDefault(); 
    var messageInput = document.querySelector("#my_input").value;

    if (messageInput.length == 0) {
      alert("Add some Input First Or Press Send Button!");
    } else {
      chatSocket.send(JSON.stringify({
        message: messageInput,
        username: "{{request.user.username}}",
        room_name: "{{room_name}}"
      }));
      document.querySelector("#my_input").value = ''; // Clear the input field after sending
    }
  }

  const chatbox = document.querySelector("#chatbox");


  function scrollToBottom() {
    chatbox.scrollTop = chatbox.scrollHeight;
  }

  scrollToBottom();


  const roomName = JSON.parse(document.getElementById('room_slug').textContent);

  const chatSocket = new WebSocket("ws://" + window.location.host + "/ws/" + roomName + "/");

  chatSocket.onopen = function (e) {
    console.log("The connection was setup successfully !");
  };
  chatSocket.onclose = function (e) {
    console.log("Something unexpected happened !");
  };

  document.querySelector("#my_input").focus();
  document.querySelector("#my_input").onkeyup = function (e) {
    if (e.keyCode == 13) {
      e.preventDefault();
      document.querySelector("#submit_button").click();
    }
  };
 

 chatSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);
    var messageElement = document.createElement("div");
    messageElement.className = "media w-50 mb-3"; 


    if (data.username === "{{ request.user.username }}") {
        messageElement.className = "media w-50 ml-auto mb-3"; 
        messageElement.innerHTML = `
            <div class="media-body">
                <div class="bg-primary rounded py-2 px-3 mb-2">
                    <p class="text-small mb-0 text-white">${data.message}</p>
                </div>
                <p class="small text-muted text-right">12:00 PM | Aug 13</p>
            </div>
        `;
    } else {
        messageElement.innerHTML = `
            <img src="https://bootstrapious.com/i/snippets/sn-chat/avatar.svg" alt="user" width="50" class="rounded-circle">
            <div class="media-body ml-3">
                <div class="bg-light rounded py-2 px-3 mb-2">
                    <p class="text-small mb-0 text-muted">${data.message}</p>
                </div>
                <p class="small text-muted">12:00 PM | Aug 13</p>
            </div>
        `;
    }

    document.querySelector("#chatbox").appendChild(messageElement);
    scrollToBottom();
};
</script>


{% else %}
<div class="container">
  <div class="alert alert-info d-flex justify-content-between" role="alert">
    <h5>You are not logged in</h5>

    <button type="button" class="btn btn-light"><a href="{% url 'user_login' %}">Log In</a></button>

  </div>
</div>
{% endif %}

<br>


{% endblock %} 